---
title: "Intraday"
output: pdf_document
date: "2024-05-27"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load Libraries
```{r}
library(tidyverse)
library(lubridate)
library(forecast)
library(tseries)
```


## Load and Process Data
Subset to full weeks in 2024. Remove data for non-trading hours only to avoid complexities with dealing with seasonality across the 5 trading days in a week but no volumes over weekends.
```{r}
df <- read.csv('SPY_intraday.csv')
vol <- df[c('timestamp', 'volume')]
vol$timestamp <- as.POSIXct(vol$timestamp, format = "%Y-%m-%d %H:%M:%S")
vol$timestamp <- vol$timestamp - hours(3)

# Rename columns
names(vol)[names(vol) == 'volume'] <- 'Volume'
names(vol)[names(vol) == 'timestamp'] <- 'Timestamp'

# Subset Data
start_date = "2024-01-08"
end_date = "2024-05-16"
vol = vol[vol$Timestamp >= start_date,]
vol = vol[vol$Timestamp <= end_date,]


# Define 24 hours per day and volume = 0 for each time with no trading
start_date <- as.Date(min(vol$Timestamp))
end_date <- as.Date(max(vol$Timestamp))
all_hours <- seq.POSIXt(as.POSIXct(paste(start_date, "00:00:00")), 
                        as.POSIXct(paste(end_date, "23:00:00")), 
                        by = "hour")
full_data <- data.frame(Timestamp = all_hours) %>%
  left_join(vol, by = "Timestamp") %>%
  replace_na(list(Volume = 0))

vol <- full_data


# Define separate date and time columns
vol$Date <- as.Date(vol$Timestamp, origin = "1904-01-01", tz = "PST8PDT")
vol$Time <- format(vol$Timestamp,"%H:%M:%S")


# Remove 3/10/24 due to complications with attributing time due to daylight savings
vol = vol[vol$Date != "2024-03-10",]


# Extract Trading Hours data only
trading_hours <- vol %>%
  filter(wday(Timestamp, week_start = 1) %in% 1:5 & 
         ((hour(Timestamp) == 9) | 
          (hour(Timestamp) > 9 & hour(Timestamp) < 16) | 
          (hour(Timestamp) == 16)))

# Remove Holidays
trading_hours = trading_hours[trading_hours$Date != '2024-01-15',]
trading_hours = trading_hours[trading_hours$Date != '2024-02-19',]
trading_hours = trading_hours[trading_hours$Date != '2024-03-29',]
trading_hours = trading_hours[trading_hours$Date != '2024-05-16',]


plot(trading_hours$Volume, type = 'l')
```



## EDA
Volume spikes in first couple hours of trading, then dies down, then again spikes at the close.

Strong seasonality component.

```{r}
# Plot Data (Incl Weekends/Non-trading Hours)
start_date = "2024-01-01" # SUBSETS ONLY FOR PLOT!!!
subsetvol = vol[vol$Timestamp >= start_date,]
plot(subsetvol$Timestamp, subsetvol$Volume, type = 'l', main = 'SPY Intraday Trading Volume 2024')




# Average hourly trading volume
avghourlyvolume <- vol %>%
                      group_by(Time) %>%
                      summarise(avgvol = mean(Volume),
                                sdvol = sd(Volume))

avghourlyvolume$Time <- as.POSIXct(avghourlyvolume$Time, format = "%H:%M:%S")


U = avghourlyvolume$avgvol + avghourlyvolume$sdvol
L = avghourlyvolume$avgvol - avghourlyvolume$sdvol

plot(avghourlyvolume$Time, avghourlyvolume$avgvol, type = 'l',
     xlim=as.POSIXct(c("2024-05-27 9:00:00","2024-05-27 18:00:00")),
     ylim=c(0, 23000000),
     main = "Average Hourly Trading Volume",
     xlab = "Time of Day",
     ylab = "Volume")
points(avghourlyvolume$Time, U, col = "red", type = "l")
points(avghourlyvolume$Time, L, col = "red", type = "l")
abline(v=as.POSIXct(c("2024-05-27 9:30:00", "2024-05-27 16:00:00")), col="blue")




# ACF/PACF plots
acf(trading_hours$Volume)
pacf(trading_hours$Volume)


# Convert to time series - frequency is weekly because of issues that arise due to no trading on weekends if freq = 24
ts_data <- ts(trading_hours$Volume, frequency = 8)

# Decompose Time Series
decomp <- decompose(ts_data)
plot(decomp)

```



## Model Fitting
### a) ARIMA()
```{r}
# Fit best ARIMA model
fit <- auto.arima(ts_data, seasonal = TRUE)
summary(fit)

residuals <- fit$residuals
plot(residuals)
checkresiduals(fit)

# Forecast
forecast_values <- forecast(fit, h=16)
plot(forecast_values)

```
